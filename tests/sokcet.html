<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Socket Stream</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.min.js"></script>
</head>
<body>

    <div id="app">
        <ul>
            <li v-for="log in logs">{{ log }}</li>
        </ul>
    </div>

<script>

var ready = false;
if (Notification.permission == "granted") {
    ready = true;
}else{
    Notification.requestPermission().then(function(result) {
        console.log(result);
        ready = true;
    });
}


function senNotify(log){
    var type = 'producer';
    if(log.proxy) type = 'proxy';
    var typeValue = log[type];
    var voterStaked = log.staked / 10000;

    if(log.lastRank){
        var message = typeValue+" rank changed from "+log.lastRank +" to "+log.rank;
    }else if(log.type){
        console.log('notify', log.type);
    }else{
        var message = [
            log.voter+' -> ',
                type == 'producer' ?
                    log.action ==  "add" ? '[vote producer] -> ' : '[remove producer] -> ' :
                log.action ==  "add" ? '[set proxy] -> ' : '[remove proxy] -> ',
            '['+typeValue+']',
            "staked="+(log.staked / 10000).toFixed(2)+' EOS'
        ].join(" ");
        console.log(message)
    }

    var notification = new Notification("change", {
        body: message
    });
    
    notification.onclick = function() {
        notification.close();    
    };


    setTimeout(() => {
        notification.close();   
    },  3000);
    console.log(message)
}


var app = new Vue({
    data: function () {
        return {
            logs: []
        }
    },
    mounted: function () {
        var socket = io('https://api.tallymeter.io');
        socket.on('log', (log) => {
            console.log('log', log);
            senNotify(log);
            this.logs.push(log);
        })
    },
}).$mount('#app');
</script>



</body>
</html>